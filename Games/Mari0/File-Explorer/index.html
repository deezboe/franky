<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndexedDB File Explorer with Upload</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .explorer-container {
            display: flex;
            gap: 20px;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background-color: #f5f5f5;
            border-radius: 5px;
            padding: 15px;
            height: 600px;
            overflow-y: auto;
        }
        
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .refresh-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #6200ee;
        }
        
        .database-list {
            list-style: none;
            padding: 0;
        }
        
        .database-item {
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 4px;
        }
        
        .database-item:hover {
            background-color: rgba(98, 0, 238, 0.08);
        }
        
        .database-item.active {
            background-color: rgba(98, 0, 238, 0.12);
            font-weight: 500;
        }
        
        /* Main Content Styles */
        .main-content {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            height: 600px;
            overflow-y: auto;
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            border-radius: 5px;
        }
        
        .upload-area:hover {
            background-color: #f9f9f9;
        }
        
        .item-list {
            list-style: none;
            padding: 0;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .item-card {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .item-card:hover {
            border-color: #9e47ff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .item-icon {
            font-size: 36px;
            color: #6200ee;
            margin-bottom: 8px;
        }
        
        .item-name {
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .item-meta {
            font-size: 0.8rem;
            color: #757575;
        }
        
        .item-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: none;
        }
        
        .item-card:hover .item-actions {
            display: flex;
            gap: 4px;
        }
        
        .item-action-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #555;
        }
        
        .item-action-btn:hover {
            background: #6200ee;
            color: white;
        }
        
        /* Preview Styles */
        .preview {
            width: 300px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            height: 600px;
            overflow-y: auto;
        }
        
        .preview-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .preview-content {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        /* Status Bar */
        .status-bar {
            margin-top: 10px;
            padding: 8px;
            font-size: 0.8rem;
            color: #757575;
        }
        
        /* Progress Bar */
        .progress-bar {
            height: 4px;
            background-color: #f0f0f0;
            margin-top: 10px;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s;
        }
        
        /* File preview styles */
        .file-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 8px;
        }
        
        .binary-preview {
            color: #757575;
            font-style: italic;
        }
        
        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #757575;
            text-align: center;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <h1>IndexedDB File Explorer with Upload</h1>
    
    <div class="explorer-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>Databases</h3>
                <button class="refresh-btn" id="refresh-btn" title="Refresh">
                    <span class="material-icons">refresh</span>
                </button>
            </div>
            <ul class="database-list" id="database-list">
                <li class="database-item"><span class="material-icons">hourglass_empty</span>Loading...</li>
            </ul>
        </div>
        
        <!-- Main Content -->
        <div class="main-content" id="main-content">
            <div class="empty-state">
                <span class="material-icons empty-icon">folder_open</span>
                <div>Select a database or object store to view contents</div>
            </div>
        </div>
        
        <!-- Preview Pane -->
        <div class="preview" id="preview">
            <div class="preview-header">
                <h3>Preview</h3>
            </div>
            <div class="preview-content" id="preview-content">
                Select an item to preview its contents
            </div>
        </div>
    </div>
    
    <!-- Hidden file input for uploads -->
    <input type="file" id="file-upload" style="display: none;" multiple>
    
    <!-- Status Bar -->
    <div class="status-bar" id="status-bar">Ready</div>
    <div class="progress-bar" id="progressContainer" style="display: none;">
        <div class="progress" id="progressBar"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // State management
            const state = {
                currentDb: null,
                currentStore: null,
                currentItem: null,
                databases: []
            };

            // DOM elements
            const databaseList = document.getElementById('database-list');
            const mainContent = document.getElementById('main-content');
            const previewContent = document.getElementById('preview-content');
            const refreshBtn = document.getElementById('refresh-btn');
            const statusBar = document.getElementById('status-bar');
            const fileUpload = document.getElementById('file-upload');
            const progressBar = document.getElementById('progressBar');
            const progressContainer = document.getElementById('progressContainer');

            // Initialize the explorer
            refreshDatabases();

            // Event listeners
            refreshBtn.addEventListener('click', refreshDatabases);
            fileUpload.addEventListener('change', handleFileUpload);

            // Functions
            function refreshDatabases() {
                updateStatus('Loading databases...');
                databaseList.innerHTML = '<li class="database-item"><span class="material-icons">hourglass_empty</span>Loading...</li>';
                
                indexedDB.databases().then(databases => {
                    state.databases = databases;
                    renderDatabaseList(databases);
                    updateStatus(`${databases.length} databases found`);
                }).catch(error => {
                    databaseList.innerHTML = '<li class="database-item"><span class="material-icons">error</span>Error loading databases</li>';
                    updateStatus('Error loading databases: ' + error.message, true);
                    console.error('Error loading databases:', error);
                });
            }

            function renderDatabaseList(databases) {
                databaseList.innerHTML = '';
                
                if (databases.length === 0) {
                    databaseList.innerHTML = '<li class="database-item"><span class="material-icons">info</span>No databases found</li>';
                    return;
                }

                databases.forEach(db => {
                    const dbItem = document.createElement('li');
                    dbItem.className = 'database-item';
                    dbItem.dataset.dbName = db.name;
                    dbItem.dataset.dbVersion = db.version;
                    dbItem.innerHTML = `
                        <span class="material-icons">storage</span>
                        <div>
                            <div>${db.name}</div>
                            <div class="item-meta">Version: ${db.version}</div>
                        </div>
                    `;
                    
                    dbItem.addEventListener('click', () => openDatabase(db.name, db.version));
                    databaseList.appendChild(dbItem);
                });
            }

            function openDatabase(dbName, version) {
                updateStatus(`Opening database: ${dbName}`);
                state.currentDb = dbName;
                state.currentStore = null;
                state.currentItem = null;
                
                // Update active state in sidebar
                document.querySelectorAll('.database-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.dbName === dbName);
                });
                
                // Open the database to get object stores
                const request = indexedDB.open(dbName, version);
                
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    const storeNames = Array.from(db.objectStoreNames);
                    db.close();
                    
                    renderObjectStores(storeNames);
                    updateStatus(`Database opened: ${dbName} (${storeNames.length} object stores)`);
                };
                
                request.onerror = (event) => {
                    updateStatus(`Error opening database: ${event.target.error}`, true);
                    console.error('Error opening database:', event.target.error);
                };
            }

            function renderObjectStores(storeNames) {
                mainContent.innerHTML = '';
                
                if (storeNames.length === 0) {
                    mainContent.innerHTML = `
                        <div class="empty-state">
                            <span class="material-icons empty-icon">info</span>
                            <div>No object stores found in this database</div>
                        </div>
                    `;
                    return;
                }
                
                const header = document.createElement('div');
                header.className = 'content-header';
                header.innerHTML = `
                    <div class="content-title">Object Stores</div>
                `;
                mainContent.appendChild(header);
                
                const list = document.createElement('ul');
                list.className = 'item-list';
                
                storeNames.forEach(storeName => {
                    const item = document.createElement('li');
                    item.className = 'item-card';
                    item.dataset.storeName = storeName;
                    item.innerHTML = `
                        <div class="item-icon material-icons">folder</div>
                        <div class="item-name">${storeName}</div>
                        <div class="item-meta">Object Store</div>
                    `;
                    
                    item.addEventListener('click', () => openObjectStore(storeName));
                    list.appendChild(item);
                });
                
                mainContent.appendChild(list);
            }

            function openObjectStore(storeName) {
                updateStatus(`Loading items from: ${storeName}`);
                state.currentStore = storeName;
                state.currentItem = null;
                
                // Open the database and object store
                const request = indexedDB.open(state.currentDb);
                
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    const transaction = db.transaction(storeName, 'readonly');
                    const store = transaction.objectStore(storeName);
                    const items = [];
                    
                    // Get all items in the store
                    const cursorRequest = store.openCursor();
                    
                    cursorRequest.onsuccess = (event) => {
                        const cursor = event.target.result;
                        if (cursor) {
                            items.push({
                                key: cursor.key,
                                value: cursor.value,
                                storeName: storeName
                            });
                            cursor.continue();
                        } else {
                            db.close();
                            renderStoreItems(items);
                            updateStatus(`Loaded ${items.length} items from ${storeName}`);
                        }
                    };
                    
                    cursorRequest.onerror = (event) => {
                        db.close();
                        updateStatus(`Error reading items: ${event.target.error}`, true);
                        console.error('Error reading items:', event.target.error);
                    };
                };
                
                request.onerror = (event) => {
                    updateStatus(`Error opening database: ${event.target.error}`, true);
                    console.error('Error opening database:', event.target.error);
                };
            }

            function renderStoreItems(items) {
                mainContent.innerHTML = '';
                
                if (items.length === 0) {
                    mainContent.innerHTML = `
                        <div class="empty-state">
                            <span class="material-icons empty-icon">info</span>
                            <div>No items found in this object store</div>
                        </div>
                        <div class="upload-area" id="upload-area">
                            <p><span class="material-icons">cloud_upload</span><br>Drag & drop files here or click to select</p>
                            <button class="action-btn" id="upload-btn">
                                <span class="material-icons">upload</span>
                                Select Files
                            </button>
                        </div>
                    `;
                    
                    // Setup upload area
                    const uploadArea = document.getElementById('upload-area');
                    const uploadBtn = document.getElementById('upload-btn');
                    
                    uploadArea.addEventListener('click', () => fileUpload.click());
                    uploadArea.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        uploadArea.style.backgroundColor = '#f0f0f0';
                    });
                    
                    uploadArea.addEventListener('dragleave', () => {
                        uploadArea.style.backgroundColor = '';
                    });
                    
                    uploadArea.addEventListener('drop', (e) => {
                        e.preventDefault();
                        uploadArea.style.backgroundColor = '';
                        if (e.dataTransfer.files.length) {
                            handleFileUpload({ target: { files: e.dataTransfer.files } });
                        }
                    });
                    
                    uploadBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        fileUpload.click();
                    });
                    
                    return;
                }
                
                const header = document.createElement('div');
                header.className = 'content-header';
                header.innerHTML = `
                    <div class="content-title">Items in ${state.currentStore}</div>
                    <div class="content-actions">
                        <button class="action-btn" id="upload-btn">
                            <span class="material-icons">upload</span>
                            Upload Files
                        </button>
                    </div>
                `;
                mainContent.appendChild(header);
                
                // Setup upload button
                document.getElementById('upload-btn').addEventListener('click', () => {
                    fileUpload.click();
                });
                
                const list = document.createElement('ul');
                list.className = 'item-list';
                
                items.forEach(item => {
                    const displayName = extractFilename(item.key);
                    const fileType = getFileTypeInfo(item);
                    
                    const itemCard = document.createElement('li');
                    itemCard.className = 'item-card';
                    itemCard.dataset.itemKey = JSON.stringify(item.key);
                    itemCard.dataset.storeName = item.storeName;
                    itemCard.innerHTML = `
                        <div class="item-icon material-icons">insert_drive_file</div>
                        <div class="item-name">${displayName}</div>
                        <div class="item-meta">${fileType}</div>
                        <div class="item-actions">
                            <button class="item-action-btn delete-item" title="Delete">
                                <span class="material-icons" style="font-size: 16px;">delete</span>
                            </button>
                        </div>
                    `;
                    
                    itemCard.addEventListener('click', (e) => {
                        // Only preview if not clicking on action buttons
                        if (!e.target.closest('.item-action-btn')) {
                            previewItem(item);
                        }
                    });
                    
                    // Add delete handler
                    itemCard.querySelector('.delete-item').addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteItem(item);
                    });
                    
                    list.appendChild(itemCard);
                });
                
                mainContent.appendChild(list);
            }

            async function handleFileUpload(event) {
                const files = event.target.files;
                if (!files || files.length === 0) return;
                
                updateStatus(`Uploading ${files.length} file(s) to ${state.currentStore}`);
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                
                try {
                    const request = indexedDB.open(state.currentDb);
                    
                    request.onsuccess = (event) => {
                        const db = event.target.result;
                        const transaction = db.transaction(state.currentStore, 'readwrite');
                        const store = transaction.objectStore(state.currentStore);
                        
                        let filesProcessed = 0;
                        const totalFiles = files.length;
                        
                        Array.from(files).forEach(file => {
                            const reader = new FileReader();
                            
                            reader.onload = (e) => {
                                // Use the filename as the key
                                const putRequest = store.put(file, file.name);
                                
                                putRequest.onsuccess = () => {
                                    filesProcessed++;
                                    const progress = Math.floor((filesProcessed / totalFiles) * 100);
                                    progressBar.style.width = `${progress}%`;
                                    
                                    if (filesProcessed === totalFiles) {
                                        updateStatus(`Successfully uploaded ${totalFiles} file(s)`);
                                        setTimeout(() => {
                                            progressContainer.style.display = 'none';
                                            // Refresh the current view
                                            openObjectStore(state.currentStore);
                                        }, 500);
                                    }
                                };
                                
                                putRequest.onerror = (event) => {
                                    updateStatus(`Error uploading file ${file.name}: ${event.target.error}`, true);
                                    console.error('Error uploading file:', event.target.error);
                                };
                            };
                            
                            reader.readAsArrayBuffer(file);
                        });
                        
                        transaction.oncomplete = () => {
                            db.close();
                        };
                    };
                    
                    request.onerror = (event) => {
                        updateStatus(`Error opening database: ${event.target.error}`, true);
                        console.error('Error opening database:', event.target.error);
                    };
                } catch (error) {
                    updateStatus("Error uploading files: " + error.message, 'error');
                    progressContainer.style.display = 'none';
                }
                
                // Reset the file input
                event.target.value = '';
            }

            function previewItem(item) {
                state.currentItem = item;
                
                // Highlight the selected item
                document.querySelectorAll('.item-card').forEach(card => {
                    card.classList.toggle('active', 
                        card.dataset.itemKey === JSON.stringify(item.key) && 
                        card.dataset.storeName === item.storeName
                    );
                });
                
                // Clear previous preview
                previewContent.innerHTML = '';
                
                // Handle different types of values
                if (item.value instanceof Blob) {
                    // Handle Blob (likely a file)
                    const url = URL.createObjectURL(item.value);
                    
                    if (item.value.type.startsWith('image/')) {
                        // Image preview
                        const img = document.createElement('img');
                        img.src = url;
                        img.className = 'file-preview';
                        img.onload = () => {
                            URL.revokeObjectURL(url);
                        };
                        previewContent.appendChild(img);
                    } else if (item.value.type.startsWith('text/')) {
                        // Text file preview
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const pre = document.createElement('pre');
                            const code = document.createElement('code');
                            code.textContent = e.target.result;
                            pre.appendChild(code);
                            previewContent.appendChild(pre);
                        };
                        reader.readAsText(item.value);
                    } else {
                        // Binary file info
                        const div = document.createElement('div');
                        div.className = 'binary-preview';
                        div.textContent = `Binary file: ${item.value.type} (${formatFileSize(item.value.size)})`;
                        previewContent.appendChild(div);
                    }
                } else if (item.value instanceof ArrayBuffer) {
                    // ArrayBuffer info
                    const div = document.createElement('div');
                    div.className = 'binary-preview';
                    div.textContent = `ArrayBuffer: ${formatFileSize(item.value.byteLength)}`;
                    previewContent.appendChild(div);
                } else if (typeof item.value === 'object' && item.value !== null) {
                    // JSON data
                    try {
                        const pre = document.createElement('pre');
                        const code = document.createElement('code');
                        code.textContent = JSON.stringify(item.value, null, 2);
                        pre.appendChild(code);
                        previewContent.appendChild(pre);
                    } catch (e) {
                        previewContent.textContent = `[Unable to display value: ${e.message}]`;
                    }
                } else {
                    // Primitive value
                    previewContent.textContent = String(item.value);
                }
            }

            function deleteItem(item) {
                if (!confirm(`Are you sure you want to delete "${extractFilename(item.key)}"?`)) {
                    return;
                }
                
                updateStatus(`Deleting item: ${extractFilename(item.key)}`);
                
                const request = indexedDB.open(state.currentDb);
                
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    const transaction = db.transaction(item.storeName, 'readwrite');
                    const store = transaction.objectStore(item.storeName);
                    const deleteRequest = store.delete(item.key);
                    
                    deleteRequest.onsuccess = () => {
                        updateStatus(`Item "${extractFilename(item.key)}" deleted`);
                        // Refresh the current view
                        openObjectStore(state.currentStore);
                    };
                    
                    deleteRequest.onerror = (event) => {
                        updateStatus(`Error deleting item: ${event.target.error}`, true);
                        console.error('Error deleting item:', event.target.error);
                    };
                    
                    transaction.oncomplete = () => {
                        db.close();
                    };
                };
                
                request.onerror = (event) => {
                    updateStatus(`Error opening database: ${event.target.error}`, true);
                    console.error('Error opening database:', event.target.error);
                };
            }

            function extractFilename(key) {
                if (typeof key === 'string' && key.includes('/')) {
                    const parts = key.split('/');
                    return parts[parts.length - 1];
                }
                return formatKey(key);
            }

            function getFileTypeInfo(item) {
                if (typeof item.key === 'string' && item.key.includes('/')) {
                    const filename = extractFilename(item.key);
                    const extension = filename.includes('.') 
                        ? filename.split('.').pop().toUpperCase() 
                        : 'FILE';
                    return `${extension} file | ${getValueType(item.value)}`;
                }
                return `Key: ${typeof item.key} | Value: ${getValueType(item.value)}`;
            }

            function getValueType(value) {
                if (value instanceof ArrayBuffer) return 'ArrayBuffer';
                if (value instanceof Blob) return 'Blob';
                return typeof value;
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            function formatKey(key) {
                if (typeof key === 'object' && key !== null) {
                    try {
                        return JSON.stringify(key);
                    } catch (e) {
                        return '[Complex Key]';
                    }
                }
                return String(key);
            }

            function updateStatus(message, isError = false) {
                statusBar.innerHTML = isError 
                    ? `<span style="color: #b00020">${message}</span>`
                    : message;
            }
        });
    </script>
</body>
</html>
