<!DOCTYPE html>
<html>
<head>
    <title>IndexedDB File Explorer</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&family=Roboto+Mono&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4285f4;
            --hover-color: #e8f0fe;
            --border-color: #dadce0;
            --text-color: #202124;
            --secondary-text: #5f6368;
        }
        
        body {
            font-family: 'Roboto', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            color: var(--text-color);
        }
        
        .database-header {
            font-weight: bold;
            margin-top: 15px;
            color: var(--primary-color);
        }
        
        .store-header {
            margin-left: 20px;
            color: #34a853;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            margin-left: 40px;
            padding: 6px 0;
            font-family: 'Roboto Mono', monospace;
        }
        
        .file-path {
            flex-grow: 1;
        }
        
        .edit-button {
            margin-left: 10px;
            padding: 4px 8px;
            background: #f1f3f4;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
        }
        
        .edit-button:hover {
            background: #e8f0fe;
        }
        
        .preview-pane {
            margin-top: 20px;
            padding: 16px;
            border-top: 1px solid var(--border-color);
        }
        
        .preview-title {
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .preview-content {
            font-family: 'Roboto Mono', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
        }
        
        button {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <h1>IndexedDB Explorer</h1>
    
    <button id="refreshBtn">
        <span class="material-icons">refresh</span>
        Refresh
    </button>
    
    <div id="databaseContainer"></div>
    
    <div class="preview-pane" id="previewPane">
        <div class="preview-title">Preview</div>
        <div class="preview-content" id="previewContent">Select an item to preview</div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const databaseContainer = document.getElementById('databaseContainer');
        const previewContent = document.getElementById('previewContent');
        const refreshBtn = document.getElementById('refreshBtn');
        
        refreshBtn.addEventListener('click', refreshDatabases);
        
        async function refreshDatabases() {
            try {
                databaseContainer.innerHTML = '';
                
                // Get all databases
                const databases = await indexedDB.databases();
                
                if (databases.length === 0) {
                    databaseContainer.innerHTML = '<p>No IndexedDB databases found.</p>';
                    return;
                }
                
                databases.forEach(db => {
                    if (!db.name) return;
                    
                    // Create database header
                    const dbHeader = document.createElement('div');
                    dbHeader.className = 'database-header';
                    dbHeader.textContent = `Database: ${db.name}`;
                    databaseContainer.appendChild(dbHeader);
                    
                    // Open the database to get object stores
                    const request = indexedDB.open(db.name);
                    
                    request.onsuccess = function(event) {
                        const dbInstance = event.target.result;
                        const storeNames = Array.from(dbInstance.objectStoreNames);
                        
                        if (storeNames.length === 0) {
                            const noStores = document.createElement('p');
                            noStores.textContent = 'No object stores in this database';
                            noStores.style.marginLeft = '20px';
                            databaseContainer.appendChild(noStores);
                            return;
                        }
                        
                        storeNames.forEach(storeName => {
                            // Create store header
                            const storeHeader = document.createElement('div');
                            storeHeader.className = 'store-header';
                            storeHeader.textContent = `Store: ${storeName}`;
                            databaseContainer.appendChild(storeHeader);
                            
                            // Get all items in the store
                            const transaction = dbInstance.transaction(storeName, 'readonly');
                            const store = transaction.objectStore(storeName);
                            const getAllRequest = store.getAll();
                            
                            getAllRequest.onsuccess = function(event) {
                                const items = event.target.result;
                                
                                if (items.length === 0) {
                                    const noItems = document.createElement('p');
                                    noItems.textContent = 'No items in this store';
                                    noItems.style.marginLeft = '40px';
                                    databaseContainer.appendChild(noItems);
                                    return;
                                }
                                
                                items.forEach(item => {
                                    const fileItem = document.createElement('div');
                                    fileItem.className = 'file-item';
                                    
                                    // Create full path
                                    const path = `${db.name}/${storeName}/${getItemName(item)}`;
                                    
                                    // Create path display
                                    const pathSpan = document.createElement('span');
                                    pathSpan.className = 'file-path';
                                    pathSpan.textContent = path;
                                    
                                    // Create edit button
                                    const editButton = document.createElement('button');
                                    editButton.className = 'edit-button';
                                    editButton.textContent = 'Edit Data';
                                    editButton.onclick = function() {
                                        editItem(db.name, storeName, item);
                                    };
                                    
                                    // Add click handler for preview
                                    pathSpan.onclick = function() {
                                        previewItem(item);
                                    };
                                    pathSpan.style.cursor = 'pointer';
                                    
                                    fileItem.appendChild(pathSpan);
                                    fileItem.appendChild(editButton);
                                    databaseContainer.appendChild(fileItem);
                                });
                            };
                        });
                        
                        dbInstance.close();
                    };
                    
                    request.onerror = function(event) {
                        console.error('Error opening database:', event.target.error);
                        const errorMsg = document.createElement('p');
                        errorMsg.textContent = `Error opening database: ${db.name}`;
                        errorMsg.style.color = '#d32f2f';
                        databaseContainer.appendChild(errorMsg);
                    };
                });
                
            } catch (error) {
                console.error('Error listing databases:', error);
                databaseContainer.innerHTML = `<p style="color: #d32f2f">Error: ${error.message}</p>`;
            }
        }
        
        function getItemName(item) {
            if (typeof item === 'object' && item !== null) {
                // Check for common name properties
                const nameKeys = ['name', 'fileName', 'filename', 'title', 'id', 'key'];
                for (const key of nameKeys) {
                    if (item[key] !== undefined) {
                        return item[key];
                    }
                }
                // If no name property, stringify the object
                return JSON.stringify(item).slice(0, 50) + '...';
            }
            return item;
        }
        
        function previewItem(item) {
            try {
                previewContent.textContent = JSON.stringify(item, null, 2);
            } catch (error) {
                previewContent.textContent = `Error displaying item: ${error.message}`;
            }
        }
        
        function editItem(dbName, storeName, item) {
            const currentValue = JSON.stringify(item, null, 2);
            const newValue = prompt(`Edit data for ${getItemName(item)}:`, currentValue);
            
            if (newValue === null) return;
            
            try {
                const parsedValue = JSON.parse(newValue);
                const request = indexedDB.open(dbName);
                
                request.onsuccess = function(event) {
                    const db = event.target.result;
                    const transaction = db.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    
                    // Determine if we're updating by key or putting new value
                    let updateRequest;
                    if (item.key !== undefined) {
                        updateRequest = store.put(parsedValue, item.key);
                    } else if (item.id !== undefined) {
                        updateRequest = store.put(parsedValue, item.id);
                    } else {
                        updateRequest = store.put(parsedValue);
                    }
                    
                    updateRequest.onsuccess = function() {
                        alert('Item updated successfully!');
                        refreshDatabases();
                    };
                    
                    updateRequest.onerror = function(event) {
                        alert(`Error updating item: ${event.target.error}`);
                    };
                };
                
                request.onerror = function(event) {
                    alert(`Error opening database: ${event.target.error}`);
                };
            } catch (error) {
                alert(`Error parsing JSON: ${error.message}`);
            }
        }
        
        // Initial load
        refreshDatabases();
    });
    </script>
</body>
</html>
