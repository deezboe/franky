<!DOCTYPE html>
<html>
<head>
    <title>IndexedDB File Explorer</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #controls { margin-bottom: 20px; padding: 10px; background: #f5f5f5; border-radius: 5px; }
        #file-explorer { border: 1px solid #ddd; padding: 10px; margin-top: 10px; min-height: 300px; }
        .file-item { padding: 5px; cursor: pointer; display: flex; align-items: center; }
        .file-item:hover { background-color: #f0f0f0; }
        .directory { font-weight: bold; }
        .file-icon { margin-right: 8px; color: #666; }
        .breadcrumb { display: flex; margin-bottom: 10px; flex-wrap: wrap; }
        .breadcrumb-item { cursor: pointer; color: #0066cc; margin-right: 5px; }
        .breadcrumb-item:hover { text-decoration: underline; }
        .breadcrumb-separator { margin: 0 5px; color: #999; }
        #file-content { margin-top: 20px; border: 1px solid #ddd; padding: 15px; background: #f9f9f9; }
        #upload-area { border: 2px dashed #ccc; padding: 20px; text-align: center; margin-top: 10px; }
        #upload-area.highlight { border-color: #0066cc; background: #e6f0ff; }
        button { padding: 8px 15px; margin-right: 5px; background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0052a3; }
        button:disabled { background: #cccccc; cursor: not-allowed; }
        input[type="text"] { padding: 8px; width: 300px; margin-right: 10px; }
        .context-menu { position: absolute; background: white; border: 1px solid #ddd; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); z-index: 1000; }
        .context-menu-item { padding: 8px 15px; cursor: pointer; }
        .context-menu-item:hover { background: #f0f0f0; }
    </style>
</head>
<body>
    <h1>IndexedDB File Explorer</h1>
    
    <div id="controls">
        <div>
            <select id="db-select"></select>
            <button id="refresh-dbs">Refresh Databases</button>
        </div>
        
        <div style="margin-top: 15px;">
            <input type="text" id="new-item-name" placeholder="Name for new folder/file">
            <button id="create-folder">New Folder</button>
            <button id="upload-toggle">Upload Files</button>
            <button id="delete-item" disabled>Delete Selected</button>
        </div>
        
        <div id="upload-area" style="display: none;">
            <p>Drag & drop files here or click to browse</p>
            <input type="file" id="file-input" multiple style="display: none;">
        </div>
    </div>
    
    <div class="breadcrumb" id="breadcrumb"></div>
    
    <div id="file-explorer"></div>
    
    <div id="file-content">
        <h3 id="content-title"></h3>
        <div id="content-display"></div>
    </div>
    
    <script>
        // Global variables
        let db;
        let currentDbName = '';
        let currentPath = [];
        let selectedItem = null;
        
        // Initialize the explorer
        document.addEventListener('DOMContentLoaded', () => {
            // Setup event listeners
            document.getElementById('refresh-dbs').addEventListener('click', loadDatabases);
            document.getElementById('db-select').addEventListener('change', onDatabaseSelect);
            document.getElementById('create-folder').addEventListener('click', createFolder);
            document.getElementById('upload-toggle').addEventListener('click', toggleUploadArea);
            document.getElementById('delete-item').addEventListener('click', deleteSelectedItem);
            
            // File upload handling
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileUpload);
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('highlight');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('highlight');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('highlight');
                if (e.dataTransfer.files.length > 0) {
                    handleFileUpload({ target: { files: e.dataTransfer.files } });
                }
            });
            
            // Load initial databases
            loadDatabases();
        });
        
        // Load all available databases
        async function loadDatabases() {
            const dbSelect = document.getElementById('db-select');
            dbSelect.innerHTML = '<option value="">Select a database</option>';
            
            try {
                const databases = await window.indexedDB.databases();
                
                databases.forEach(dbInfo => {
                    const option = document.createElement('option');
                    option.value = dbInfo.name;
                    option.textContent = `${dbInfo.name} (v${dbInfo.version})`;
                    dbSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading databases:', error);
                alert('Error loading databases: ' + error.message);
            }
        }
        
        // When a database is selected
        function onDatabaseSelect(e) {
            currentDbName = e.target.value;
            if (!currentDbName) return;
            
            openDatabase(currentDbName);
        }
        
        // Open the selected database
        function openDatabase(dbName) {
            const request = indexedDB.open(dbName);
            
            request.onerror = (event) => {
                console.error('Database error:', event.target.error);
                alert('Error opening database: ' + event.target.error);
            };
            
            request.onsuccess = (event) => {
                db = event.target.result;
                currentPath = []; // Reset to root
                loadFiles();
            };
            
            request.onupgradeneeded = (event) => {
                // This shouldn't happen since we're not requesting a version upgrade
                console.warn('Database upgrade needed');
            };
        }
        
        // Load files for current path
        function loadFiles() {
            if (!db) return;
            
            const transaction = db.transaction(['files'], 'readonly');
            const store = transaction.objectStore('files');
            const index = store.index('path');
            const request = index.getAll(IDBKeyRange.only(currentPath));
            
            request.onsuccess = () => {
                const files = request.result;
                displayFiles(files);
                updateBreadcrumb();
            };
            
            request.onerror = () => {
                console.error('Error loading files');
            };
        }
        
        // Display files in the explorer
        function displayFiles(files) {
            const explorer = document.getElementById('file-explorer');
            explorer.innerHTML = '';
            
            // Filter files for current path and sort (directories first)
            const currentFiles = files.filter(file => 
                JSON.stringify(file.path) === JSON.stringify(currentPath)
            ).sort((a, b) => {
                if (a.isDirectory && !b.isDirectory) return -1;
                if (!a.isDirectory && b.isDirectory) return 1;
                return a.name.localeCompare(b.name);
            });
            
            if (currentFiles.length === 0) {
                explorer.innerHTML = '<p>This folder is empty</p>';
                return;
            }
            
            currentFiles.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = `file-item ${file.isDirectory ? 'directory' : 'file'}`;
                fileItem.dataset.id = file.id;
                
                fileItem.innerHTML = `
                    <span class="file-icon">${file.isDirectory ? 'üìÅ' : 'üìÑ'}</span>
                    <span>${file.name}${file.isDirectory ? '/' : ''}</span>
                `;
                
                fileItem.addEventListener('click', () => {
                    // Remove selection from other items
                    document.querySelectorAll('.file-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    
                    // Add selection to clicked item
                    fileItem.classList.add('selected');
                    selectedItem = file;
                    document.getElementById('delete-item').disabled = false;
                    
                    if (file.isDirectory) {
                        // Navigate into directory
                        currentPath = [...file.path, file.name];
                        loadFiles();
                    } else {
                        // Display file content
                        displayFileContent(file);
                    }
                });
                
                // Context menu for right-click
                fileItem.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showContextMenu(e, file);
                });
                
                explorer.appendChild(fileItem);
            });
        }
        
        // Update the breadcrumb navigation
        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            breadcrumb.innerHTML = '';
            
            // Root item
            const rootItem = document.createElement('span');
            rootItem.className = 'breadcrumb-item';
            rootItem.textContent = 'root';
            rootItem.addEventListener('click', () => {
                currentPath = [];
                loadFiles();
            });
            breadcrumb.appendChild(rootItem);
            
            // Path items
            currentPath.forEach((segment, index) => {
                const separator = document.createElement('span');
                separator.className = 'breadcrumb-separator';
                separator.textContent = '/';
                breadcrumb.appendChild(separator);
                
                const pathItem = document.createElement('span');
                pathItem.className = 'breadcrumb-item';
                pathItem.textContent = segment;
                
                const pathToHere = currentPath.slice(0, index + 1);
                pathItem.addEventListener('click', () => {
                    currentPath = pathToHere;
                    loadFiles();
                });
                
                breadcrumb.appendChild(pathItem);
            });
        }
        
        // Display file content
        function displayFileContent(file) {
            document.getElementById('content-title').textContent = file.name;
            const contentDisplay = document.getElementById('content-display');
            
            if (file.type && file.type.startsWith('image/')) {
                contentDisplay.innerHTML = `<img src="${URL.createObjectURL(new Blob([file.content]))}" style="max-width: 100%;">`;
            } else if (typeof file.content === 'string') {
                contentDisplay.textContent = file.content;
            } else {
                // For binary data that's not an image
                contentDisplay.innerHTML = '<p>Binary file - ' + file.size + ' bytes</p>';
            }
        }
        
        // Create a new folder
        function createFolder() {
            const folderName = document.getElementById('new-item-name').value.trim();
            if (!folderName) {
                alert('Please enter a folder name');
                return;
            }
            
            if (!db) {
                alert('No database selected');
                return;
            }
            
            const transaction = db.transaction(['files'], 'readwrite');
            const store = transaction.objectStore('files');
            
            // Check if name already exists in this path
            const checkRequest = store.index('path').getAll(IDBKeyRange.only(currentPath));
            
            checkRequest.onsuccess = () => {
                const existingItems = checkRequest.result;
                const nameExists = existingItems.some(item => 
                    item.name === folderName && item.path === currentPath
                );
                
                if (nameExists) {
                    alert('An item with this name already exists in this location');
                    return;
                }
                
                // Add the new folder
                const addRequest = store.add({
                    name: folderName,
                    path: currentPath,
                    isDirectory: true,
                    content: '',
                    created: new Date(),
                    modified: new Date()
                });
                
                addRequest.onsuccess = () => {
                    document.getElementById('new-item-name').value = '';
                    loadFiles();
                };
                
                addRequest.onerror = () => {
                    console.error('Error creating folder');
                };
            };
        }
        
        // Toggle the upload area visibility
        function toggleUploadArea() {
            const uploadArea = document.getElementById('upload-area');
            uploadArea.style.display = uploadArea.style.display === 'none' ? 'block' : 'none';
        }
        
        // Handle file uploads
        function handleFileUpload(event) {
            if (!db) {
                alert('No database selected');
                return;
            }
            
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            const transaction = db.transaction(['files'], 'readwrite');
            const store = transaction.objectStore('files');
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const content = e.target.result;
                    
                    // Check if file already exists
                    const checkRequest = store.index('path').getAll(IDBKeyRange.only(currentPath));
                    
                    checkRequest.onsuccess = () => {
                        const existingItems = checkRequest.result;
                        const nameExists = existingItems.some(item => 
                            item.name === file.name && item.path === currentPath
                        );
                        
                        if (nameExists) {
                            if (!confirm(`"${file.name}" already exists. Overwrite?`)) {
                                return;
                            }
                            
                            // Find and update existing file
                            const existingFile = existingItems.find(item => item.name === file.name);
                            if (existingFile) {
                                existingFile.content = content;
                                existingFile.size = file.size;
                                existingFile.type = file.type;
                                existingFile.modified = new Date();
                                
                                const updateRequest = store.put(existingFile);
                                updateRequest.onsuccess = () => {
                                    loadFiles();
                                };
                            }
                        } else {
                            // Add new file
                            const addRequest = store.add({
                                name: file.name,
                                path: currentPath,
                                isDirectory: false,
                                content: content,
                                size: file.size,
                                type: file.type,
                                created: new Date(),
                                modified: new Date()
                            });
                            
                            addRequest.onsuccess = () => {
                                loadFiles();
                            };
                        }
                    };
                };
                
                if (file.type && file.type.startsWith('text/')) {
                    reader.readAsText(file);
                } else {
                    reader.readAsArrayBuffer(file);
                }
            });
            
            // Reset file input
            event.target.value = '';
            document.getElementById('upload-area').style.display = 'none';
        }
        
        // Delete the selected item
        function deleteSelectedItem() {
            if (!selectedItem || !db) return;
            
            if (!confirm(`Are you sure you want to delete "${selectedItem.name}"?`)) {
                return;
            }
            
            const transaction = db.transaction(['files'], 'readwrite');
            const store = transaction.objectStore('files');
            
            if (selectedItem.isDirectory) {
                // Check if directory is empty
                const checkRequest = store.index('path').getAll(
                    IDBKeyRange.only([...selectedItem.path, selectedItem.name])
                );
                
                checkRequest.onsuccess = () => {
                    if (checkRequest.result.length > 0) {
                        alert('Cannot delete non-empty directory');
                    } else {
                        const deleteRequest = store.delete(selectedItem.id);
                        deleteRequest.onsuccess = () => {
                            selectedItem = null;
                            document.getElementById('delete-item').disabled = true;
                            loadFiles();
                        };
                    }
                };
            } else {
                // Delete file
                const deleteRequest = store.delete(selectedItem.id);
                deleteRequest.onsuccess = () => {
                    selectedItem = null;
                    document.getElementById('delete-item').disabled = true;
                    document.getElementById('content-title').textContent = '';
                    document.getElementById('content-display').innerHTML = '';
                    loadFiles();
                };
            }
        }
        
        // Show context menu
        function showContextMenu(e, file) {
            // Remove any existing context menu
            const existingMenu = document.querySelector('.context-menu');
            if (existingMenu) existingMenu.remove();
            
            // Create new menu
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.left = `${e.pageX}px`;
            menu.style.top = `${e.pageY}px`;
            
            // Add menu items
            const downloadItem = document.createElement('div');
            downloadItem.className = 'context-menu-item';
            downloadItem.textContent = 'Download';
            downloadItem.addEventListener('click', () => downloadFile(file));
            menu.appendChild(downloadItem);
            
            const deleteItem = document.createElement('div');
            deleteItem.className = 'context-menu-item';
            deleteItem.textContent = 'Delete';
            deleteItem.addEventListener('click', () => {
                selectedItem = file;
                deleteSelectedItem();
                menu.remove();
            });
            menu.appendChild(deleteItem);
            
            if (!file.isDirectory) {
                const renameItem = document.createElement('div');
                renameItem.className = 'context-menu-item';
                renameItem.textContent = 'Rename';
                renameItem.addEventListener('click', () => renameFile(file));
                menu.appendChild(renameItem);
            }
            
            document.body.appendChild(menu);
            
            // Close menu when clicking elsewhere
            const closeMenu = () => {
                menu.remove();
                document.removeEventListener('click', closeMenu);
            };
            
            setTimeout(() => {
                document.addEventListener('click', closeMenu);
            }, 100);
        }
        
        // Download a file
        function downloadFile(file) {
            let blob;
            if (file.content instanceof ArrayBuffer || file.content instanceof Blob) {
                blob = new Blob([file.content], { type: file.type });
            } else {
                blob = new Blob([file.content], { type: 'text/plain' });
            }
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = file.name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Rename a file
        function renameFile(file) {
            const newName = prompt('Enter new name:', file.name);
            if (!newName || newName.trim() === '') return;
            
            const transaction = db.transaction(['files'], 'readwrite');
            const store = transaction.objectStore('files');
            
            // Check if name already exists in this path
            const checkRequest = store.index('path').getAll(IDBKeyRange.only(file.path));
            
            checkRequest.onsuccess = () => {
                const existingItems = checkRequest.result;
                const nameExists = existingItems.some(item => 
                    item.name === newName && item.id !== file.id
                );
                
                if (nameExists) {
                    alert('An item with this name already exists in this location');
                    return;
                }
                
                // Update the file
                file.name = newName;
                file.modified = new Date();
                
                const updateRequest = store.put(file);
                updateRequest.onsuccess = () => {
                    loadFiles();
                };
            };
        }
    </script>
</body>
</html>
