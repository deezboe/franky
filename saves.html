<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndexedDB File Explorer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        section {
            margin-bottom: 30px;
        }
        h2 {
            color: #333;
        }
        ul {
            list-style-type: none;
            padding-left: 0;
        }
        li {
            margin: 5px 0;
            color: #555;
        }
        .database {
            font-weight: bold;
            margin-top: 15px;
            cursor: pointer;
        }
        .store {
            margin-left: 20px;
            cursor: pointer;
        }
        .entry {
            margin-left: 40px;
            color: #333;
            cursor: pointer;
        }
        .entry-button {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
        }
        .edit-button {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
        }
        .delete-button {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            background-color: #f44336;
            color: white;
        }
        .expand-icon {
            margin-right: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <section id="indexeddb">
        <h2>IndexedDB Explorer</h2>
        <ul id="indexeddb-list">
            <!-- IndexedDB databases will be displayed here -->
        </ul>
    </section>

    <script>
        const indexeddbList = document.getElementById("indexeddb-list");

        // Function to get all IndexedDB databases and their contents
        function getIndexedDBData() {
            const request = indexedDB.databases();

            request.then(databases => {
                if (databases.length === 0) {
                    const li = document.createElement("li");
                    li.textContent = "No IndexedDB databases found.";
                    indexeddbList.appendChild(li);
                } else {
                    databases.forEach(db => {
                        const dbName = db.name;
                        const dbEntry = document.createElement("li");
                        dbEntry.classList.add("database");
                        dbEntry.textContent = `Database: ${dbName}`;
                        dbEntry.onclick = () => toggleVisibility(dbEntry);

                        const expandIcon = document.createElement("span");
                        expandIcon.classList.add("expand-icon");
                        expandIcon.textContent = "▶️";  // Arrow icon for expansion
                        expandIcon.onclick = (e) => toggleExpand(e, dbEntry);

                        dbEntry.insertBefore(expandIcon, dbEntry.firstChild);
                        indexeddbList.appendChild(dbEntry);

                        // Open the database to get object stores
                        const openRequest = indexedDB.open(dbName, db.version);

                        openRequest.onsuccess = function(event) {
                            const dbInstance = event.target.result;
                            const objectStoreNames = dbInstance.objectStoreNames;

                            // Convert the DOMStringList to an array and iterate over it
                            const storeNamesArray = Array.from(objectStoreNames);
                            
                            if (storeNamesArray.length === 0) return;

                            storeNamesArray.forEach(storeName => {
                                const storeEntry = document.createElement("li");
                                storeEntry.classList.add("store");
                                storeEntry.textContent = `Store: ${storeName}`;
                                storeEntry.onclick = () => toggleVisibility(storeEntry);

                                const expandIcon = document.createElement("span");
                                expandIcon.classList.add("expand-icon");
                                expandIcon.textContent = "▶️";  // Arrow icon for expansion
                                expandIcon.onclick = (e) => toggleExpand(e, storeEntry);

                                storeEntry.insertBefore(expandIcon, storeEntry.firstChild);
                                dbEntry.appendChild(storeEntry);

                                // Open a transaction for the store to access its keys
                                const transaction = dbInstance.transaction(storeName, "readonly");
                                const objectStore = transaction.objectStore(storeName);

                                // Using openCursor to iterate through the store and retrieve keys
                                const cursorRequest = objectStore.openCursor();

                                cursorRequest.onsuccess = function(event) {
                                    const cursor = event.target.result;
                                    if (cursor) {
                                        const entryItem = document.createElement("li");
                                        entryItem.classList.add("entry");
                                        entryItem.textContent = `Key: ${cursor.key}`;

                                        // Create "Edit Data" button for each IndexedDB entry
                                        const editButton = document.createElement("button");
                                        editButton.textContent = "Edit Data";
                                        editButton.classList.add("edit-button");
                                        editButton.onclick = function() {
                                            editData(cursor.key, 'indexedDB', dbName, storeName);
                                        };

                                        // Create "Delete Data" button for each IndexedDB entry
                                        const deleteButton = document.createElement("button");
                                        deleteButton.textContent = "Delete";
                                        deleteButton.classList.add("delete-button");
                                        deleteButton.onclick = function() {
                                            deleteData(cursor.key, 'indexedDB', dbName, storeName);
                                        };

                                        entryItem.appendChild(editButton);
                                        entryItem.appendChild(deleteButton);
                                        storeEntry.appendChild(entryItem);
                                        cursor.continue();
                                    }
                                };

                                cursorRequest.onerror = function() {
                                    const errorItem = document.createElement("li");
                                    errorItem.classList.add("entry");
                                    errorItem.textContent = "Error retrieving keys from store.";
                                    storeEntry.appendChild(errorItem);
                                };
                            });
                        };

                        openRequest.onerror = function() {
                            const errorItem = document.createElement("li");
                            errorItem.classList.add("database");
                            errorItem.textContent = `Error opening database: ${dbName}`;
                            indexeddbList.appendChild(errorItem);
                        };
                    });
                }
            }).catch(error => {
                const li = document.createElement("li");
                li.textContent = "Error fetching IndexedDB databases: " + error;
                indexeddbList.appendChild(li);
            });
        }

        // Toggle visibility of child nodes (stores or entries)
        function toggleVisibility(element) {
            const isVisible = element.classList.contains("expanded");
            if (isVisible) {
                element.classList.remove("expanded");
            } else {
                element.classList.add("expanded");
            }
        }

        // Toggle the expansion icon (▶️ / ▼)
        function toggleExpand(event, element) {
            event.stopPropagation();
            const icon = event.target;
            const isExpanded = element.classList.contains("expanded");
            if (isExpanded) {
                icon.textContent = "▶️";  // Closed icon
                element.classList.remove("expanded");
            } else {
                icon.textContent = "▼";  // Opened icon
                element.classList.add("expanded");
            }
        }

        // Function to handle editing data
        function editData(key, storageType, dbName, storeName) {
            let newValue = prompt("Enter new value for " + key);
            if (newValue !== null) {
                if (storageType === 'indexedDB' && dbName && storeName) {
                    const openRequest = indexedDB.open(dbName, 1);

                    openRequest.onsuccess = function(event) {
                        const dbInstance = event.target.result;
                        const transaction = dbInstance.transaction(storeName, "readwrite");
                        const objectStore = transaction.objectStore(storeName);
                        const updateRequest = objectStore.put(newValue, key);

                        updateRequest.onsuccess = function() {
                            alert(`IndexedDB data for ${key} updated successfully!`);
                        };

                        updateRequest.onerror = function() {
                            alert("Error updating IndexedDB data.");
                        };
                    };

                    openRequest.onerror = function() {
                        alert("Error opening IndexedDB database.");
                    };
                }
            }
        }

        // Function to delete data from IndexedDB
        function deleteData(key, storageType, dbName, storeName) {
            if (confirm(`Are you sure you want to delete the entry with key: ${key}?`)) {
                if (storageType === 'indexedDB' && dbName && storeName) {
                    const openRequest = indexedDB.open(dbName, 1);

                    openRequest.onsuccess = function(event) {
                        const dbInstance = event.target.result;
                        const transaction = dbInstance.transaction(storeName, "readwrite");
                        const objectStore = transaction.objectStore(storeName);
                        const deleteRequest = objectStore.delete(key);

                        deleteRequest.onsuccess = function() {
                            alert(`IndexedDB entry with key ${key} deleted successfully!`);
                            location.reload(); // Reload the page to reflect changes
                        };

                        deleteRequest.onerror = function() {
                            alert("Error deleting IndexedDB entry.");
                        };
                    };

                    openRequest.onerror = function() {
                        alert("Error opening IndexedDB database.");
                    };
                }
            }
        }

        // Run the function to get IndexedDB data
        getIndexedDBData();
    </script>
</body>
</html>
